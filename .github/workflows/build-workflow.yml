on:
  push:
    branches: [ php-7.4-ubuntu-20.04 ]
    
env:
  REPO: "orangehrm/orangehrm-environment-images"
  TAG: "prod-php-7.4-ubuntu20.04" 
  
jobs:

    build:

      runs-on: ubuntu-latest
      steps:
       - name: testing script
         run: echo Hello world      
       
       - name: Get the checkout  
         uses: actions/checkout@v3

       - name: Verify prerequisites
         run: |
           uname -a
           php --version
           docker --version
           docker-compose --version
           composer --version

       - name: Install test suite dependencies
         run: |
           composer update
           composer install
           docker ps        
        
       - name: Build docker image
         run: docker build -t ${{ env.REPO }}:${{ env.TAG }} docker-image  

       - name: Up the container
         run: |
           docker-compose up -d
           docker ps

       - name: Unit test 
         run: php vendor/bin/codecept run unit

       - name: Push the latest image to the docker hub
         run: docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
         run: docker push ${{ env.REPO }}:${{ env.TAG }}
      